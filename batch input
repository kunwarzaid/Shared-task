\begin{figure*}[t]
\centering
\begin{tikzpicture}[font=\small,
  node distance=10mm and 16mm,
  box/.style={rectangle,rounded corners,draw=black!70,minimum width=40mm,minimum height=12mm,align=center,inner sep=6pt},
  agent/.style={box,fill=blue!6},
  proc/.style={box,fill=green!6},
  log/.style={box,fill=orange!10,minimum width=60mm},
  store/.style={box,fill=gray!10},
  metr/.style={box,fill=green!10},
  flow/.style={-{Stealth[length=3mm,width=2mm]},line width=.8pt},
  trace/.style={dashed,gray,-{Stealth[length=2.5mm,width=1.8mm]},line width=.6pt}
]

% --- Row 1 (top) ---
\node[agent] (doctor) at (0,1.8) {Doctor Agent\\(Reasoning, DDx, Requests)};
\node[proc]  (measure) at (7,1.8) {Measurement Agent\\(Tests, Results, Ground Truth)};

% --- Row 2 (middle) ---
\node[agent] (patient) at (0,-0.6) {Patient Agent\\(Responds from Case Profile)};
\node[proc]  (safety)  at (7,-0.6) {Safety Agents\\(Test/Prescription Risk, DDI Checks)};

% --- Central logging layer ---
\node[log,minimum width=70mm] (logger) at (3.5,0.6)
  {Explainability \& Logging Layer\\\footnotesize (timestamps, actor, event type, \texttt{<thinking\_process>}, context hashes)};

% --- Bottom row ---
\node[store] (trace)  at (0,-2.6) {Trace Store \& Replay API\\(Chronological ledger, audit trail)};
\node[metr]  (trust)  at (7,-2.6) {Trust Metrics\\(CDR, Justification Alignment, Timeout Rate)};

% --- Solid interactions ---
\draw[flow] (doctor) -- node[above,sloped,pos=.5]{REQUEST TEST} (measure);
\draw[flow] (measure) -- node[below,sloped,pos=.5]{Test Result} (doctor);

\draw[flow] (doctor) -- node[left,pos=.5]{Question / Request} (patient);
\draw[flow] (patient) -- node[right,pos=.5]{Answer / Symptoms} (doctor);

\draw[flow] (doctor.south east) to[bend left=18] node[right,pos=.45]{Prescription} (safety.north west);
\draw[flow] (safety.north west) to[bend left=18] node[left,pos=.45]{Safety Verdict / Flags} (doctor.south east);

% --- Dashed logging to central layer ---
\draw[trace] (doctor) -- (logger);
\draw[trace] (patient) -- (logger);
\draw[trace] (measure) -- (logger);
\draw[trace] (safety) -- (logger);

% --- From logging to storage/metrics ---
\draw[flow] (logger.south west) to[bend left=18] node[left,pos=.45]{Persist / Index} (trace.north);
\draw[flow] (logger.south east) to[bend right=18] node[right,pos=.45]{Compute} (trust.north);

\end{tikzpicture}
\caption{MedGuard\textendash X architecture. The Doctor Agent interacts with Patient and Measurement Agents to collect evidence, maintains an evolving differential diagnosis (DDx), and consults Safety Agents to evaluate test and prescription risks (including potential drug\textendash drug interactions, DDIs). All actions stream structured logs (timestamps, actor, event type, and reasoning traces like \texttt{<thinking\_process>}) to the Explainability \& Logging Layer for replay, auditing, and trust metrics (e.g., Consensus Disagreement Rate and Justification Alignment).}
\label{fig:logging-architecture}
\end{figure*}
