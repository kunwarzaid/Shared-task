% ---------------------
% PASTE THIS IN YOUR PREAMBLE
% ---------------------
\usepackage{tikz}
\usetikzlibrary{
  positioning,   % allows "right=of", "below=of"
  calc,          % basic coordinate arithmetic
  arrows.meta,   % nicer arrow tips
  shapes,        % rounded rectangles etc
  fit,           % grouping nodes
  backgrounds    % optional if you want bg boxes
}
% optionally adjust fonts inside tikz:
\tikzset{font=\small}

% ---------------------
% PASTE THIS WHERE YOU WANT THE FIGURE (in the document body)
% Use figure* for full-width in a two-column layout.
% Use figure (single-col) if you prefer that.
% ---------------------
\begin{figure*}[t]
  \centering
  % resize to text width to avoid cropping/overflow in two-column mode
  \resizebox{\textwidth}{!}{%
  \begin{tikzpicture}[
    >=Stealth,
    agent/.style={rectangle, rounded corners, draw=black!70, fill=blue!6, inner sep=6pt, align=center, minimum width=3.6cm},
    process/.style={rectangle, rounded corners, draw=black!70, fill=green!6, inner sep=5pt, align=center, minimum width=3.4cm},
    log/.style={rectangle, rounded corners, draw=black!70, fill=yellow!10, inner sep=6pt, align=center, minimum width=4.2cm},
    trace/.style={rectangle, rounded corners, draw=black!70, fill=orange!8, inner sep=5pt, align=center, minimum width=3.6cm},
    small/.style={font=\footnotesize, inner sep=1pt}
    ]

    % Top row: Doctor (left) and Measurement (right)
    \node[agent] (doctor) {Doctor Agent\\(Reasoning, DDx, Requests)};
    \node[process, right=4.8cm of doctor] (measure) {Measurement Agent\\(Tests, Results, GT)};

    % Under Doctor: Patient
    \node[agent, below=1.4cm of doctor] (patient) {Patient Agent\\(Responds from Case Profile)};

    % Under Measurement: Safety Agents
    \node[process, below=1.4cm of measure] (safety) {Safety Agents\\(Test/Prescription Risk, DDI Checks)};

    % Central logging / explainability box between them
    \node[log, below=0.2cm of $(doctor)!0.5!(measure)$] (logger) {Explainability \& Logging Layer\\\small(Timestamp, Actor, Event, \texttt{<thinking\_process>}, Context-hash)};

    % Trace store and trust metrics at bottom-left and bottom-right
    \node[trace, below=1.6cm of logger, xshift=-4.0cm] (trace_store) {Trace Store \& Replay API\\(Chronological Ledger, Audit Trail)};
    \node[trace, below=1.6cm of logger, xshift=+4.0cm] (trust) {Trust Metrics\\(CDR, Justification Alignment, Timeout Rate)};

    % Arrows: doctor <-> patient
    \draw[->] (doctor.south) -- node[midway, left, small]{Question / Request} (patient.north);
    \draw[->] (patient.north) -- node[midway, right, small]{Answer / Symptom Info} (doctor.south);

    % Doctor -> Measurement (request)
    \draw[->] (doctor.east) .. controls +(+1.1,0.6) and +(-0.9,0.6) .. node[midway, above, small]{REQUEST TEST} (measure.west);
    % Measurement -> Doctor (result)
    \draw[->] (measure.south) .. controls +(-0.8,-0.6) and +(0.8,-0.6) .. node[midway, below, small]{Test Result} (logger.east);

    % Doctor -> Safety (prescription)
    \draw[->] (doctor.east) .. controls +(0.9,0.0) and +(-0.9,0.0) .. node[midway, above, small]{Prescription / Plan} (safety.west);
    % Safety -> Doctor (verdict)
    \draw[->] (safety.west) .. controls +(-0.6,0.6) and +(0.4,0.4) .. node[midway, above, small]{Safety Verdict} (doctor.east);

    % Logger collects from all agents (dashed lines)
    \draw[->, dashed, gray] (doctor) -- (logger);
    \draw[->, dashed, gray] (patient) -- (logger);
    \draw[->, dashed, gray] (measure) -- (logger);
    \draw[->, dashed, gray] (safety) -- (logger);

    % Logger -> Trace store and metrics
    \draw[->] (logger.south) -- node[midway, left, small]{Persist / Index} (trace_store.north);
    \draw[->] (logger.south) -- node[midway, right, small]{Compute Metrics} (trust.north);

    % Optional fit box around the central flow (a light background)
    \begin{scope}[on background layer]
      \node[fit=(doctor)(patient)(measure)(safety)(logger)(trace_store)(trust), inner sep=8pt, draw=black!10, line width=0.2pt, rounded corners, fill=gray!2] {};
    \end{scope}

  \end{tikzpicture}%
  }% end resizebox
  \caption{MedGuard-X architecture. The Doctor Agent interacts with the Patient and Measurement Agents to collect evidence, maintains an evolving differential diagnosis (DDx), and consults Safety Agents to evaluate test and prescription risks (including potential drugâ€“drug interactions). All agent actions stream structured logs (timestamps, actor, event type, and reasoning traces like \texttt{<thinking\_process>}) into the Explainability Layer for replay, auditing, and trust-metric computation (e.g., Consensus Disagreement Rate (CDR) and Justification Alignment (JA)).}
  \label{fig:logging-architecture}
\end{figure*}
