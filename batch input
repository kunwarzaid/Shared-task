\begin{figure*}[t]
\centering
\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[node distance=12mm, >=latex, thick, font=\small]

% Styles
\tikzstyle{agent}=[rectangle, rounded corners, draw=black!70, fill=blue!5,
                   minimum width=4.5cm, minimum height=1.2cm, align=center]
\tikzstyle{layer}=[rectangle, rounded corners, draw=black!70, fill=yellow!10,
                   minimum width=10.5cm, minimum height=1.2cm, align=center]
\tikzstyle{store}=[rectangle, rounded corners, draw=black!70, fill=green!5,
                   minimum width=5.3cm, minimum height=1.0cm, align=center]

% Top row (Doctor, Measurement)
\node[agent] (doctor) {Doctor Agent\\\scriptsize Reasoning, Differential Diagnosis, Orders};
\node[agent, right=30mm of doctor] (measure) {Measurement Agent\\\scriptsize Tests, Results, Ground Truth Access};

% Second row (Patient, Safety)
\node[agent, below=16mm of doctor] (patient) {Patient Agent\\\scriptsize Case-Grounded Responses};
\node[agent, below=16mm of measure] (safety) {Safety Agents\\\scriptsize Test Risk \& Prescription Safety (DDI Check)};

% Logging layer
\node[layer, below=18mm of $(patient)!0.5!(safety)$] (logger)
{Explainability \& Logging Layer:\\
Timestamps, Actor, Event Type, \texttt{<thinking\_process>}, Context Hashes};

% Storage + Metrics
\node[store, below left=10mm and 6mm of logger] (trace)
{Trace Store \& Replay API\\\scriptsize Chronological Reasoning Ledger, Audit Trails};
\node[store, below right=10mm and 6mm of logger] (metrics)
{Trust Metrics\\\scriptsize CDR, Justification Alignment, Timeout Rate, Unsafe-Rx Rate};

% Arrows: Doctor ↔ Patient
\draw[->] (doctor.south) -- node[left,pos=0.5]{\scriptsize Question} (patient.north);
\draw[->] (patient.north) -- node[right,pos=0.52]{\scriptsize Answer} (doctor.south);

% Arrows: Doctor ↔ Measurement
\draw[->] (doctor.east) -- node[above,pos=0.55]{\scriptsize REQUEST TEST} (measure.west);
\draw[->] (measure.west) -- node[below,pos=0.45]{\scriptsize Test Result} (doctor.east);

% Arrows: Doctor ↔ Safety
\draw[->] (doctor.south east) to[bend left=8] node[right,pos=0.5]{\scriptsize Prescription} (safety.north);
\draw[->] (safety.north) to[bend left=8] node[left,pos=0.5]{\scriptsize Safety Verdict} (doctor.south east);

% Logging taps (gray arrows)
\draw[->,gray!70] (doctor.south) ++(0,-2mm) -- (logger.north -| doctor);
\draw[->,gray!70] (patient.south) -- (logger.north -| patient);
\draw[->,gray!70] (measure.south) -- (logger.north -| measure);
\draw[->,gray!70] (safety.south) -- (logger.north -| safety);

% From logging to storage/metrics
\draw[->,black!70] (logger.south) -- node[left]{\scriptsize persist} (trace.north);
\draw[->,black!70] (logger.south) -- node[right]{\scriptsize compute} (metrics.north);

\end{tikzpicture}
}
\caption{MedGuard-X architecture. The Doctor Agent interacts with the Patient and Measurement Agents to collect evidence, maintains an evolving differential diagnosis (DDx), and consults Safety Agents to evaluate test and prescription risks, including potential drug--drug interactions (DDIs). All agent actions stream structured logs containing timestamps, actor roles, and reasoning traces (\texttt{<thinking\_process>}) to the Explainability Layer, enabling replay, auditing, and computation of trust metrics such as Consensus Disagreement Rate (CDR) and Justification Alignment (JA).}
\label{fig:logging-architecture}
\end{figure*}

\usepackage{tikz}
\usetikzlibrary{positioning, arrows.meta}
